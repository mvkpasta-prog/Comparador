<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Frete - Planilha x XML CTE</title>
    <style>
        :root {
            --primary: #2563eb;
            --accent: #0ea5e9;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        .container {
            display: grid;
            gap: 30px;
        }
        .card {
            background: var(--card);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 1.4rem;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        button:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }
        button.loading {
            background: var(--info);
            cursor: wait;
        }
        .file-input {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            text-align: center;
            background-color: #f8fafc;
            transition: all 0.3s ease;
        }
        .file-input:hover {
            border-color: var(--primary);
            background-color: #f1f5f9;
        }
        .file-input p {
            margin-bottom: 15px;
            color: var(--muted);
        }
        #xmlFiles {
            display: none;
        }
        .file-label {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .file-label:hover {
            background: #0284c7;
        }
        #statusMessage {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        .status-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .status-success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .status-loading {
            background-color: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.95rem;
            min-width: 800px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        tr:hover {
            background-color: #f1f5f9;
        }
        .match {
            background-color: #dcfce7 !important;
        }
        .mismatch {
            background-color: #fee2e2 !important;
        }
        .result-summary {
            background: var(--card);
            padding: 20px;
            border-radius: 10px;
            margin: 30px 0;
            border: 1px solid #e2e8f0;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary-item {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #bae6fd;
        }
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        .summary-label {
            font-size: 0.9rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .card {
                padding: 20px;
            }
            table {
                min-width: 600px;
            }
            th, td {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Comparador de Frete - Planilha Google Sheets x XML CTE</h1>
    </header>

    <div class="container">
        <div class="card">
            <h2>üì• Carregar Dados da Planilha</h2>
            <p>Os dados ser√£o carregados diretamente da planilha p√∫blica do Google Sheets.</p>
            <button id="btnCarregarPlanilha">Carregar Dados da Planilha</button>
            <div id="statusMessage" class="status-info">
                Clique no bot√£o acima para carregar os dados da planilha.
            </div>
        </div>

        <div class="card">
            <h2>üìÑ Anexar XMLs dos CT-e</h2>
            <div class="file-input">
                <p>Selecione os arquivos XML dos Conhecimentos de Transporte Eletr√¥nico (CT-e)</p>
                <label for="xmlFiles" class="file-label">
                    Escolher Arquivos XML
                </label>
                <input type="file" id="xmlFiles" multiple accept=".xml">
                <p id="fileCount">Nenhum arquivo selecionado</p>
            </div>
            <button id="btnProcessar" disabled>Processar Compara√ß√£o</button>
        </div>

        <div class="card">
            <h2>üìä Resultados da Compara√ß√£o</h2>
            <div id="resultadosContainer">
                <p>Ainda n√£o h√° resultados. Carregue os dados da planilha e os XMLs para come√ßar a compara√ß√£o.</p>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o da planilha
        const SHEET_ID = '1CZZgYJiZic9pyFFTdyldm_gVwn2K-zSGY9uhFJ5Nz6Q';
        const GID = '1183141602'; // GID da aba PROGRAMA√á√ÉO

        let dadosPlanilhaAgrupados = null;

        // Elementos do DOM
        const btnCarregarPlanilha = document.getElementById('btnCarregarPlanilha');
        const btnProcessar = document.getElementById('btnProcessar');
        const xmlFilesInput = document.getElementById('xmlFiles');
        const fileCount = document.getElementById('fileCount');
        const statusMessage = document.getElementById('statusMessage');
        const resultadosContainer = document.getElementById('resultadosContainer');

        // Event Listeners - CORRIGIDO: Adicionado preventDefault e garantido funcionamento
        btnCarregarPlanilha.addEventListener('click', function(e) {
            e.preventDefault();
            carregarDadosPlanilha();
        });
        
        btnProcessar.addEventListener('click', function(e) {
            e.preventDefault();
            processarComparacao();
        });
        
        xmlFilesInput.addEventListener('change', function() {
            const files = this.files;
            if (files.length > 0) {
                fileCount.textContent = `${files.length} arquivo(s) selecionado(s)`;
                if (dadosPlanilhaAgrupados) {
                    btnProcessar.disabled = false;
                }
            } else {
                fileCount.textContent = 'Nenhum arquivo selecionado';
                btnProcessar.disabled = true;
            }
        });

        // Fun√ß√£o para carregar dados da planilha - TOTALMENTE CORRIGIDA
        async function carregarDadosPlanilha() {
            // Desabilitar bot√£o e mostrar status de carregamento
            btnCarregarPlanilha.disabled = true;
            btnCarregarPlanilha.classList.add('loading');
            statusMessage.innerHTML = '<div class="spinner"></div> Carregando dados da planilha...';
            statusMessage.className = 'status-loading';

            try {
                // URL p√∫blica SEM necessidade de API Key
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;
                console.log("URL da planilha:", url); // Para debug
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Erro ao carregar planilha: ${response.status} ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log("Dados CSV recebidos (primeiros 200 caracteres):", text.substring(0, 200)); // Para debug
                
                const dados = parseCSV(text);
                
                if (!dados || !dados.arrays || dados.arrays.length === 0) {
                    throw new Error('Nenhum dado encontrado na planilha');
                }
                
                // Processar os dados conforme sua l√≥gica
                dadosPlanilhaAgrupados = processarDadosDaPlanilha(dados.arrays);
                
                // Mensagem de sucesso
                statusMessage.innerHTML = `‚úÖ Dados carregados com sucesso! ${dadosPlanilhaAgrupados.length} registros agrupados.`;
                statusMessage.className = 'status-success';
                
                // Habilitar bot√£o de processar se houver arquivos XML selecionados
                if (xmlFilesInput.files.length > 0) {
                    btnProcessar.disabled = false;
                }
                
            } catch (error) {
                console.error("Erro ao carregar dados da planilha:", error);
                statusMessage.innerHTML = `‚ùå Erro: ${error.message}`;
                statusMessage.className = 'status-error';
            } finally {
                btnCarregarPlanilha.disabled = false;
                btnCarregarPlanilha.classList.remove('loading');
            }
        }

        // Fun√ß√£o para parsear CSV - ADAPTADA DO SEU C√ìDIGO
        function parseCSV(text) {
            if (!text) return { arrays: [], headersOrig: [], headersNorm: [] };
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length === 0) return { arrays: [], headersOrig: [], headersNorm: [] };
            
            // Processar cada linha, tratando campos entre aspas
            const parsed = lines.map(line => 
                line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim())
            );
            
            const headersOrig = parsed.shift().map(h => h || '');
            const headersNorm = headersOrig.map(h => normalizeHeader(h));
            
            return { arrays: parsed, headersOrig, headersNorm };
        }

        // Fun√ß√£o para normalizar cabe√ßalho - ADAPTADA DO SEU C√ìDIGO
        function normalizeHeader(h) {
            if (h === undefined || h === null) return '';
            return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]/g, '');
        }

        // Fun√ß√£o para processar dados da planilha - TOTALMENTE CORRIGIDA
        function processarDadosDaPlanilha(rows) {
            if (rows.length === 0) {
                throw new Error("Nenhuma linha de dados encontrada");
            }
            
            // Processar linhas
            const dadosProcessados = [];
            for (let i = 0; i < rows.length; i++) {
                const linha = rows[i];
                
                // Extrair valores pelas posi√ß√µes fixas (A=0, E=4, H=7, J=9, K=10)
                 linha[0] ? linha[0].toString().trim() : '';
                let freteStr = linha[4] ? linha[4].toString().trim() : '0';
                const placa = linha[7] ? linha[7].toString().trim() : '';
                let pesoStr = linha[9] ? linha[9].toString().trim() : '0';
                let nf = linha[10] ? linha[10].toString().trim() : '';
                
                // Processar NF: remover "NF" e manter s√≥ n√∫meros
                nf = nf.replace(/[^0-9]/g, '');
                
                // Processar frete: remover R$, pontos, substituir v√≠rgula por ponto
                freteStr = freteStr.replace(/[R$\s.]/g, '').replace(',', '.');
                const frete = parseFloat(freteStr) || 0;
                
                // Processar peso: substituir v√≠rgula por ponto
                pesoStr = pesoStr.replace(/\./g, '').replace(',', '.');
                const peso = parseFloat(pesoStr) || 0;
                
                // Ignorar linhas sem data, placa ou NF
                if (!data || !placa || !nf) continue;
                
                dadosProcessados.push({
                     data,
                    frete: frete,
                    placa: placa,
                    peso: peso,
                    nf: nf
                });
            }
            
            // Agrupar por data, placa e NF
            const agrupados = {};
            dadosProcessados.forEach(item => {
                const chave = `${item.data}|${item.placa}|${item.nf}`;
                if (!agrupados[chave]) {
                    agrupados[chave] = {
                         item.data,
                        placa: item.placa,
                        nf: item.nf,
                        pesoTotal: 0,
                        freteOriginal: 0,
                        valorCalculado: 0,
                        itens: []
                    };
                }
                agrupados[chave].pesoTotal += item.peso;
                agrupados[chave].freteOriginal += item.frete;
                agrupados[chave].itens.push(item);
            });
            
            // Calcular valor final (frete / 0.92)
            Object.values(agrupados).forEach(item => {
                item.valorCalculado = item.freteOriginal / 0.92;
            });
            
            return Object.values(agrupados);
        }

        // Fun√ß√£o para processar compara√ß√£o
        function processarComparacao() {
            const xmlFiles = xmlFilesInput.files;
            
            if (xmlFiles.length === 0) {
                alert('Por favor, selecione pelo menos um arquivo XML.');
                return;
            }
            
            if (!dadosPlanilhaAgrupados) {
                alert('Dados da planilha n√£o carregados. Carregue primeiro os dados da planilha.');
                return;
            }
            
            btnProcessar.disabled = true;
            btnProcessar.classList.add('loading');
            statusMessage.innerHTML = '<div class="spinner"></div> Processando XMLs e comparando dados...';
            statusMessage.className = 'status-loading';
            
            // Processar XMLs
            processarXMLs(xmlFiles, dadosPlanilhaAgrupados);
        }

        // Fun√ß√£o para processar XMLs
        function processarXMLs(xmlFiles, dadosPlanilha) {
            const leitor = new FileReader();
            let xmlIndex = 0;
            const resultadosXML = [];
            
            function processarProximoXML() {
                if (xmlIndex >= xmlFiles.length) {
                    // Todos processados, mostrar resultados
                    mostrarResultados(dadosPlanilha, resultadosXML);
                    btnProcessar.disabled = false;
                    btnProcessar.classList.remove('loading');
                    statusMessage.innerHTML = '‚úÖ Compara√ß√£o conclu√≠da!';
                    statusMessage.className = 'status-success';
                    return;
                }
                
                const arquivo = xmlFiles[xmlIndex];
                leitor.onload = function(e) {
                    try {
                        const xmlContent = e.target.result;
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                        
                        // Extrair dados do XML CTE
                        let chaveCTe = '';
                        let valorFrete = 0;
                        let placa = '';
                        let dataEmissao = '';
                        let nfReferenciada = '';
                        
                        // Tentar diferentes namespaces e estruturas
                        const namespaces = ["", "nfe:", "cte:"];
                        
                        // Procurar chave do CTe
                        for (const ns of namespaces) {
                            const infCte = xmlDoc.querySelector(`${ns}infCte`);
                            if (infCte) {
                                chaveCTe = infCte.getAttribute('Id') || '';
                                if (chaveCTe.startsWith('CTe')) {
                                    chaveCTe = chaveCTe.substring(3);
                                }
                                break;
                            }
                        }
                        
                        // Procurar valor do frete
                        for (const ns of namespaces) {
                            const vFrete = xmlDoc.querySelector(`${ns}vFrete`);
                            if (vFrete && vFrete.textContent) {
                                valorFrete = parseFloat(vFrete.textContent.replace(',', '.')) || 0;
                                break;
                            }
                        }
                        
                        // Procurar placa
                        for (const ns of namespaces) {
                            const placaEl = xmlDoc.querySelector(`${ns}placa`);
                            if (placaEl && placaEl.textContent) {
                                placa = placaEl.textContent.trim();
                                break;
                            }
                        }
                        
                        // Procurar data de emiss√£o
                        for (const ns of namespaces) {
                            const dhEmi = xmlDoc.querySelector(`${ns}dhEmi`);
                            if (dhEmi && dhEmi.textContent) {
                                const data = new Date(dhEmi.textContent);
                                dataEmissao = data.toISOString().split('T')[0];
                                break;
                            }
                        }
                        
                        // Procurar nota fiscal referenciada
                        for (const ns of namespaces) {
                            let nfeRef = xmlDoc.querySelector(`${ns}refNFe`) || 
                                       xmlDoc.querySelector(`${ns}chaveNFe`);
                            
                            if (nfeRef && nfeRef.textContent) {
                                nfReferenciada = nfeRef.textContent.trim();
                                // Extrair apenas os n√∫meros
                                nfReferenciada = nfReferenciada.replace(/[^0-9]/g, '');
                                // Se tiver mais de 10 d√≠gitos, pegar os √∫ltimos 10 (n√∫mero da NF)
                                if (nfReferenciada.length > 10) {
                                    nfReferenciada = nfReferenciada.slice(-10);
                                }
                                break;
                            }
                        }
                        
                        resultadosXML.push({
                            arquivo: arquivo.name,
                            chaveCTe: chaveCTe,
                            valorFrete: valorFrete,
                            placa: placa,
                            dataEmissao: dataEmissao,
                            nfReferenciada: nfReferenciada,
                            xmlContent: xmlContent
                        });
                        
                        xmlIndex++;
                        processarProximoXML();
                    } catch (error) {
                        console.error('Erro ao processar XML:', arquivo.name, error);
                        xmlIndex++;
                        processarProximoXML();
                    }
                };
                
                leitor.readAsText(arquivo, 'UTF-8');
            }
            
            // Iniciar processamento
            processarProximoXML();
        }

        // Fun√ß√£o para mostrar resultados
        function mostrarResultados(dadosPlanilha, resultadosXML) {
            let html = `
                <h3>üìã Compara√ß√£o Detalhada</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Placa</th>
                            <th>NF</th>
                            <th>Peso Total (KG)</th>
                            <th>Frete Planilha (R$)</th>
                            <th>Valor Calculado (√∑0.92)</th>
                            <th>Frete XML (R$)</th>
                            <th>Diferen√ßa (R$)</th>
                            <th>Status</th>
                            <th>Arquivo XML</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Para cada registro da planilha, procurar correspondente no XML
            dadosPlanilha.forEach(registroPlanilha => {
                let xmlCorrespondente = null;
                
                // Procurar por correspond√™ncia (data, placa e NF)
                for (const xml of resultadosXML) {
                    const dataMatch = !xml.dataEmissao || xml.dataEmissao === registroPlanilha.data;
                    const placaMatch = !xml.placa || xml.placa === registroPlanilha.placa;
                    const nfMatch = !xml.nfReferenciada || xml.nfReferenciada === registroPlanilha.nf;
                    
                    if (dataMatch && placaMatch && nfMatch) {
                        xmlCorrespondente = xml;
                        break;
                    }
                }
                
                const valorCalculado = registroPlanilha.valorCalculado;
                const valorXML = xmlCorrespondente ? xmlCorrespondente.valorFrete : 0;
                const diferenca = valorCalculado - valorXML;
                const status = xmlCorrespondente ? 
                    (Math.abs(diferenca) < 0.01 ? 'OK' : 'DIVERG√äNCIA') : 
                    'N√ÉO ENCONTRADO';
                
                const className = xmlCorrespondente ? 
                    (Math.abs(diferenca) < 0.01 ? 'match' : 'mismatch') : 
                    'mismatch';
                
                html += `
                    <tr class="${className}">
                        <td>${registroPlanilha.data}</td>
                        <td>${registroPlanilha.placa}</td>
                        <td>${registroPlanilha.nf}</td>
                        <td>${registroPlanilha.pesoTotal.toFixed(2)}</td>
                        <td>${registroPlanilha.freteOriginal.toFixed(2)}</td>
                        <td>${valorCalculado.toFixed(2)}</td>
                        <td>${xmlCorrespondente ? valorXML.toFixed(2) : '-'}</td>
                        <td>${xmlCorrespondente ? Math.abs(diferenca).toFixed(2) : '-'}</td>
                        <td>${status}</td>
                        <td>${xmlCorrespondente ? xmlCorrespondente.arquivo : '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div class="result-summary">
                    <h3>üìä Resumo da Compara√ß√£o</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Registros da Planilha</div>
                            <div class="summary-value">${dadosPlanilha.length}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">XMLs Processados</div>
                            <div class="summary-value">${resultadosXML.length}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Correspond√™ncias Encontradas</div>
                            <div class="summary-value">${dadosPlanilha.filter(r => {
                                return resultadosXML.some(xml => {
                                    const dataMatch = !xml.dataEmissao || xml.dataEmissao === r.data;
                                    const placaMatch = !xml.placa || xml.placa === r.placa;
                                    const nfMatch = !xml.nfReferenciada || xml.nfReferenciada === r.nf;
                                    return dataMatch && placaMatch && nfMatch;
                                });
                            }).length}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Valor Total Calculado</div>
                            <div class="summary-value">R$ ${dadosPlanilha.reduce((sum, r) => sum + r.valorCalculado, 0).toFixed(2)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Valor Total XML</div>
                            <div class="summary-value">R$ ${resultadosXML.reduce((sum, xml) => sum + xml.valorFrete, 0).toFixed(2)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Diferen√ßa Total</div>
                            <div class="summary-value">R$ ${Math.abs(
                                dadosPlanilha.reduce((sum, r) => sum + r.valorCalculado, 0) - 
                                resultadosXML.reduce((sum, xml) => sum + xml.valorFrete, 0)
                            ).toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            resultadosContainer.innerHTML = html;
        }
        
        // Inicializa√ß√£o - Garantir que tudo funcione ap√≥s o carregamento da p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log("P√°gina carregada e pronta para uso.");
        });
    </script>
</body>
</html>
