<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Frete - Planilha Pública x XML CTE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.loading {
            background-color: #007bff;
            cursor: wait;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .result-row.match {
            background-color: #d4edda;
        }
        .result-row.mismatch {
            background-color: #f8d7da;
        }
        .loading {
            color: #007bff;
        }
        .error {
            color: #dc3545;
        }
        .success {
            color: #28a745;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 15px;
            background-color: #f1f1f1;
            cursor: pointer;
            border: 1px solid #ccc;
            border-bottom: none;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
        }
        .tab-content {
            display: none;
            border: 1px solid #ccc;
            padding: 15px;
        }
        .tab-content.active {
            display: block;
        }
        #statusMessage {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Comparador de Frete - Planilha Pública x XML CTE</h1>
    
    <div class="tabs">
        <div class="tab active" onclick="openTab(event, 'instrucoes')">Instruções</div>
        <div class="tab" onclick="openTab(event, 'carregar')">Carregar Dados</div>
        <div class="tab" onclick="openTab(event, 'resultados')">Resultados</div>
    </div>

    <div id="instrucoes" class="tab-content active">
        <h2>Como usar:</h2>
        <ol>
            <li>Clique em "Carregar Dados da Planilha" para ler os dados diretamente do Google Sheets</li>
            <li>Selecione os arquivos XML dos CT-e</li>
            <li>Clique em "Processar Comparação"</li>
            <li>Veja os resultados na aba "Resultados"</li>
        </ol>
        
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3>⚙️ Funcionamento:</h3>
            <p>Este sistema lê diretamente da planilha pública usando o endpoint <code>gviz/tq?tqx=out:csv</code>, sem necessidade de API Key.</p>
            <p>Colunas utilizadas: A (Data), E (Frete), H (Placa), J (Peso), K (Nota Fiscal)</p>
        </div>
    </div>

    <div id="carregar" class="tab-content">
        <h2>Carregar Dados</h2>
        
        <button onclick="carregarDadosPlanilha()" id="btnCarregarPlanilha">Carregar Dados da Planilha</button>
        <div id="statusMessage"></div>
        
        <div class="file-input-container" style="margin-top: 20px;">
            <label for="xmlFiles">Selecione os arquivos XML:</label><br>
            <input type="file" id="xmlFiles" multiple accept=".xml">
        </div>
        
        <button onclick="processarComparacao()" id="btnProcessar" disabled>Processar Comparação</button>
        <button onclick="limparTudo()">Limpar Tudo</button>
    </div>

    <div id="resultados" class="tab-content">
        <h2>Resultados da Comparação</h2>
        <div id="resultadosContainer">
            <p>Ainda não há resultados. Carregue os dados da planilha e os XMLs para começar.</p>
        </div>
    </div>

    <script>
        let dadosPlanilhaAgrupados = null;
        const SHEET_ID = '1CZZgYJiZic9pyFFTdyldm_gVwn2K-zSGY9uhFJ5Nz6Q';
        const GID = '1183141602'; // GID da aba PROGRAMAÇÃO
        
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].className = tabcontent[i].className.replace(" active", "");
            }
            tablinks = document.getElementsByClassName("tab");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).className += " active";
            evt.currentTarget.className += " active";
        }

        function limparTudo() {
            document.getElementById('xmlFiles').value = '';
            dadosPlanilhaAgrupados = null;
            document.getElementById('btnProcessar').disabled = true;
            document.getElementById('resultadosContainer').innerHTML = '<p>Ainda não há resultados.</p>';
            document.getElementById('statusMessage').innerHTML = '';
        }
        
        async function carregarDadosPlanilha() {
            const btn = document.getElementById('btnCarregarPlanilha');
            btn.classList.add('loading');
            btn.disabled = true;
            mostrarStatus("Carregando dados da planilha...", "loading");
            
            try {
                // URL para ler a planilha como CSV usando gviz (sem API Key)
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Erro ao carregar planilha: ${response.status}`);
                }
                
                const text = await response.text();
                const dados = parseCSV(text);
                
                if (!dados || !dados.arrays || dados.arrays.length === 0) {
                    throw new Error('Nenhum dado encontrado na planilha');
                }
                
                // Processar os dados
                dadosPlanilhaAgrupados = processarDadosDaPlanilha(dados.arrays, dados.headersOrig, dados.headersNorm);
                
                // Habilitar botão de processar
                document.getElementById('btnProcessar').disabled = false;
                
                mostrarStatus(`Dados carregados com sucesso! ${dadosPlanilhaAgrupados.length} registros agrupados.`, "success");
                btn.classList.remove('loading');
                btn.disabled = false;
                
            } catch (error) {
                console.error("Erro:", error);
                mostrarStatus(`Erro: ${error.message}`, "error");
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
        
        function mostrarStatus(mensagem, tipo) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = mensagem;
            statusDiv.className = tipo;
        }
        
        /* Função para parsear CSV (adaptada do seu código) */
        function parseCSV(text) {
            if (!text) return { arrays: [], headersOrig: [], headersNorm: [] };
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length === 0) return { arrays: [], headersOrig: [], headersNorm: [] };
            
            // Processar cada linha, tratando campos entre aspas
            const parsed = lines.map(line => 
                line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim())
            );
            
            const headersOrig = parsed.shift().map(h => h || '');
            const headersNorm = headersOrig.map(h => normalizeHeader(h));
            
            return { arrays: parsed, headersOrig, headersNorm };
        }
        
        /* Normaliza cabeçalho (adaptado do seu código) */
        function normalizeHeader(h) {
            if (h === undefined || h === null) return '';
            return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]/g, '');
        }
        
        function processarDadosDaPlanilha(rows, headersOrig, headersNorm) {
            // Vamos usar os índices fixos conforme sua solicitação:
            // Coluna A (índice 0) = Data
            // Coluna E (índice 4) = Frete
            // Coluna H (índice 7) = Placa
            // Coluna J (índice 9) = Peso
            // Coluna K (índice 10) = Nota Fiscal
            
            if (rows.length === 0) {
                throw new Error("Nenhuma linha de dados encontrada");
            }
            
            // Processar linhas
            const dadosProcessados = [];
            for (let i = 0; i < rows.length; i++) {
                const linha = rows[i];
                
                // Extrair valores pelas posições fixas
                 linha[0] ? linha[0].toString().trim() : '';
                let freteStr = linha[4] ? linha[4].toString().trim() : '0';
                const placa = linha[7] ? linha[7].toString().trim() : '';
                let pesoStr = linha[9] ? linha[9].toString().trim() : '0';
                let nf = linha[10] ? linha[10].toString().trim() : '';
                
                // Processar NF: remover "NF" e manter só números
                nf = nf.replace(/[^0-9]/g, '');
                
                // Processar frete: remover R$, pontos, substituir vírgula por ponto
                freteStr = freteStr.replace(/[R$\s.]/g, '').replace(',', '.');
                const frete = parseFloat(freteStr) || 0;
                
                // Processar peso: substituir vírgula por ponto
                pesoStr = pesoStr.replace(/\./g, '').replace(',', '.');
                const peso = parseFloat(pesoStr) || 0;
                
                // Ignorar linhas sem data, placa ou NF
                if (!data || !placa || !nf) continue;
                
                dadosProcessados.push({
                     data,
                    frete: frete,
                    placa: placa,
                    peso: peso,
                    nf: nf
                });
            }
            
            // Agrupar por data, placa e NF
            const agrupados = {};
            dadosProcessados.forEach(item => {
                const chave = `${item.data}|${item.placa}|${item.nf}`;
                if (!agrupados[chave]) {
                    agrupados[chave] = {
                         item.data,
                        placa: item.placa,
                        nf: item.nf,
                        pesoTotal: 0,
                        freteOriginal: 0,
                        valorCalculado: 0,
                        itens: []
                    };
                }
                agrupados[chave].pesoTotal += item.peso;
                agrupados[chave].freteOriginal += item.frete;
                agrupados[chave].itens.push(item);
            });
            
            // Calcular valor final (frete / 0.92)
            Object.values(agrupados).forEach(item => {
                item.valorCalculado = item.freteOriginal / 0.92;
            });
            
            return Object.values(agrupados);
        }
        
        function processarComparacao() {
            const xmlFiles = document.getElementById('xmlFiles').files;
            
            if (xmlFiles.length === 0) {
                alert('Por favor, selecione pelo menos um arquivo XML.');
                return;
            }
            
            if (!dadosPlanilhaAgrupados) {
                alert('Dados da planilha não carregados. Carregue primeiro os dados da planilha.');
                return;
            }
            
            // Processar XMLs
            processarXMLs(xmlFiles, dadosPlanilhaAgrupados);
        }
        
        function processarXMLs(xmlFiles, dadosPlanilha) {
            const leitor = new FileReader();
            let xmlIndex = 0;
            const resultadosXML = [];
            
            function processarProximoXML() {
                if (xmlIndex >= xmlFiles.length) {
                    // Todos processados, mostrar resultados
                    mostrarResultados(dadosPlanilha, resultadosXML);
                    return;
                }
                
                const arquivo = xmlFiles[xmlIndex];
                leitor.onload = function(e) {
                    try {
                        const xmlContent = e.target.result;
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                        
                        // Extrair dados do XML CTE
                        let chaveCTe = '';
                        let valorFrete = 0;
                        let placa = '';
                        let dataEmissao = '';
                        let nfReferenciada = '';
                        
                        // Tentar diferentes namespaces e estruturas
                        const namespaces = ["", "nfe:", "cte:"];
                        
                        // Procurar chave do CTe
                        for (const ns of namespaces) {
                            const infCte = xmlDoc.querySelector(`${ns}infCte`);
                            if (infCte) {
                                chaveCTe = infCte.getAttribute('Id') || '';
                                if (chaveCTe.startsWith('CTe')) {
                                    chaveCTe = chaveCTe.substring(3);
                                }
                                break;
                            }
                        }
                        
                        // Procurar valor do frete
                        for (const ns of namespaces) {
                            const vFrete = xmlDoc.querySelector(`${ns}vFrete`);
                            if (vFrete && vFrete.textContent) {
                                valorFrete = parseFloat(vFrete.textContent.replace(',', '.')) || 0;
                                break;
                            }
                        }
                        
                        // Procurar placa
                        for (const ns of namespaces) {
                            const placaEl = xmlDoc.querySelector(`${ns}placa`);
                            if (placaEl && placaEl.textContent) {
                                placa = placaEl.textContent.trim();
                                break;
                            }
                        }
                        
                        // Procurar data de emissão
                        for (const ns of namespaces) {
                            const dhEmi = xmlDoc.querySelector(`${ns}dhEmi`);
                            if (dhEmi && dhEmi.textContent) {
                                const data = new Date(dhEmi.textContent);
                                dataEmissao = data.toISOString().split('T')[0];
                                break;
                            }
                        }
                        
                        // Procurar nota fiscal referenciada
                        for (const ns of namespaces) {
                            let nfeRef = xmlDoc.querySelector(`${ns}refNFe`) || 
                                       xmlDoc.querySelector(`${ns}chaveNFe`);
                            
                            if (nfeRef && nfeRef.textContent) {
                                nfReferenciada = nfeRef.textContent.trim();
                                // Extrair apenas os números
                                nfReferenciada = nfReferenciada.replace(/[^0-9]/g, '');
                                // Se tiver mais de 10 dígitos, pegar os últimos 10 (número da NF)
                                if (nfReferenciada.length > 10) {
                                    nfReferenciada = nfReferenciada.slice(-10);
                                }
                                break;
                            }
                        }
                        
                        resultadosXML.push({
                            arquivo: arquivo.name,
                            chaveCTe: chaveCTe,
                            valorFrete: valorFrete,
                            placa: placa,
                            dataEmissao: dataEmissao,
                            nfReferenciada: nfReferenciada,
                            xmlContent: xmlContent
                        });
                        
                        xmlIndex++;
                        processarProximoXML();
                    } catch (error) {
                        console.error('Erro ao processar XML:', arquivo.name, error);
                        xmlIndex++;
                        processarProximoXML();
                    }
                };
                
                leitor.readAsText(arquivo, 'UTF-8');
            }
            
            // Iniciar processamento
            processarProximoXML();
        }
        
        function mostrarResultados(dadosPlanilha, resultadosXML) {
            let html = `
                <h3>Resumo dos Dados Processados</h3>
                <p><strong>Dados da Planilha:</strong> ${dadosPlanilha.length} registros agrupados</p>
                <p><strong>XMLs Processados:</strong> ${resultadosXML.length} arquivos</p>
                
                <h3>Comparação Detalhada</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Placa</th>
                            <th>NF</th>
                            <th>Peso Total</th>
                            <th>Frete Planilha</th>
                            <th>Valor Calculado (÷0.92)</th>
                            <th>Frete XML</th>
                            <th>Diferença</th>
                            <th>Status</th>
                            <th>Arquivo XML</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Para cada registro da planilha, procurar correspondente no XML
            dadosPlanilha.forEach(registroPlanilha => {
                let xmlCorrespondente = null;
                
                // Procurar por correspondência (data, placa e NF)
                for (const xml of resultadosXML) {
                    const dataMatch = !xml.dataEmissao || xml.dataEmissao === registroPlanilha.data;
                    const placaMatch = !xml.placa || xml.placa === registroPlanilha.placa;
                    const nfMatch = !xml.nfReferenciada || xml.nfReferenciada === registroPlanilha.nf;
                    
                    if (dataMatch && placaMatch && nfMatch) {
                        xmlCorrespondente = xml;
                        break;
                    }
                }
                
                const valorCalculado = registroPlanilha.valorCalculado;
                const valorXML = xmlCorrespondente ? xmlCorrespondente.valorFrete : 0;
                const diferenca = valorCalculado - valorXML;
                const status = xmlCorrespondente ? 
                    (Math.abs(diferenca) < 0.01 ? 'OK' : 'DIVERGÊNCIA') : 
                    'NÃO ENCONTRADO';
                
                const className = xmlCorrespondente ? 
                    (Math.abs(diferenca) < 0.01 ? 'result-row match' : 'result-row mismatch') : 
                    'result-row mismatch';
                
                html += `
                    <tr class="${className}">
                        <td>${registroPlanilha.data}</td>
                        <td>${registroPlanilha.placa}</td>
                        <td>${registroPlanilha.nf}</td>
                        <td>${registroPlanilha.pesoTotal.toFixed(2)} kg</td>
                        <td>R$ ${registroPlanilha.freteOriginal.toFixed(2)}</td>
                        <td>R$ ${valorCalculado.toFixed(2)}</td>
                        <td>${xmlCorrespondente ? 'R$ ' + valorXML.toFixed(2) : '-'}</td>
                        <td>${xmlCorrespondente ? 'R$ ' + Math.abs(diferenca).toFixed(2) : '-'}</td>
                        <td>${status}</td>
                        <td>${xmlCorrespondente ? xmlCorrespondente.arquivo : '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h3>Estatísticas</h3>
                <ul>
                    <li>Registros com correspondência exata: ${dadosPlanilha.filter(r => {
                        return resultadosXML.some(xml => {
                            const dataMatch = !xml.dataEmissao || xml.dataEmissao === r.data;
                            const placaMatch = !xml.placa || xml.placa === r.placa;
                            const nfMatch = !xml.nfReferenciada || xml.nfReferenciada === r.nf;
                            return dataMatch && placaMatch && nfMatch;
                        });
                    }).length}</li>
                    <li>Registros sem correspondência: ${dadosPlanilha.filter(r => {
                        return !resultadosXML.some(xml => {
                            const dataMatch = !xml.dataEmissao || xml.dataEmissao === r.data;
                            const placaMatch = !xml.placa || xml.placa === r.placa;
                            const nfMatch = !xml.nfReferenciada || xml.nfReferenciada === r.nf;
                            return dataMatch && placaMatch && nfMatch;
                        });
                    }).length}</li>
                    <li>Valor total calculado (planilha): R$ ${dadosPlanilha.reduce((sum, r) => sum + r.valorCalculado, 0).toFixed(2)}</li>
                    <li>Valor total XML: R$ ${resultadosXML.reduce((sum, xml) => sum + xml.valorFrete, 0).toFixed(2)}</li>
                </ul>
            `;
            
            document.getElementById('resultadosContainer').innerHTML = html;
            
            // Mudar para a aba de resultados
            document.querySelector('.tab:nth-child(3)').click();
        }
    </script>
</body>
</html>
